<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Archipel P2P</title>
    <!-- ZÃ©ro dÃ©pendance externe â€” 100% offline -->
    <style>
        :root {
            --bg: #020617; --sidebar: #0f172a; --card: #1e293b;
            --accent: #0ea5e9; --accent2: #38bdf8;
            --txt: #f8fafc; --muted: #94a3b8;
            --me: #0ea5e9; --other: #334155; --r: 12px;
            --font: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { font-family: var(--font); background: var(--bg); color: var(--txt);
               display: grid; grid-template-columns: 260px 1fr 300px; height: 100vh; overflow: hidden; }

        /* Sidebars */
        aside, .right { background: var(--sidebar); display: flex; flex-direction: column; padding: 16px; overflow-y: auto; }
        aside { border-right: 1px solid #1e293b; }
        .right { border-left: 1px solid #1e293b; }
        h3 { font-size: 0.75rem; color: var(--accent); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 12px; margin-top: 16px; }
        h3:first-child { margin-top: 0; }

        /* Tabs */
        .tabs { display: flex; gap: 4px; margin-bottom: 12px; }
        .tab { padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.78rem; background: var(--card); transition: all 0.15s; }
        .tab.active { background: var(--accent); color: #000; font-weight: 700; }

        /* Peer cards */
        .peer-card { background: var(--card); padding: 10px; border-radius: var(--r); margin-bottom: 6px;
                     cursor: pointer; border: 1px solid transparent; transition: all 0.15s; }
        .peer-card:hover { border-color: var(--accent); }
        .peer-card.active { border-color: var(--accent); background: #0ea5e918; }
        .peer-name { font-weight: 600; font-size: 0.85rem; }
        .peer-info { font-size: 0.7rem; color: var(--muted); margin-top: 2px; }

        /* Main chat */
        main { display: flex; flex-direction: column; padding: 16px; }
        .chat-header { display: flex; justify-content: space-between; align-items: center;
                       padding-bottom: 12px; border-bottom: 1px solid #1e293b; margin-bottom: 12px; }
        .chat-title { font-weight: 600; font-size: 1.05rem; }
        #badge { font-size: 0.7rem; padding: 3px 10px; border-radius: 20px; background: #22c55e18; color: #22c55e; }
        #badge.off { background: #ef444418; color: #ef4444; }

        .chat-box { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; padding: 4px; }
        .b { max-width: 74%; padding: 9px 13px; border-radius: var(--r); font-size: 0.9rem; line-height: 1.45; word-break: break-word; }
        .b.me    { align-self: flex-end;   background: var(--me);    color: #000; border-bottom-right-radius: 3px; }
        .b.other { align-self: flex-start; background: var(--other); border-bottom-left-radius: 3px; }
        .b.sys   { align-self: center; background: transparent; color: var(--muted); font-size: 0.72rem; font-style: italic; }

        .input-row { background: var(--card); border-radius: var(--r); padding: 8px; display: flex; gap: 8px; margin-top: 12px; }
        input { background: transparent; border: none; color: var(--txt); padding: 8px; flex: 1; outline: none; font-size: 0.9rem; font-family: var(--font); }
        btn, button { background: var(--accent); color: #000; border: none; border-radius: 8px;
                      padding: 8px 14px; font-weight: 700; cursor: pointer; font-family: var(--font); font-size: 0.82rem; transition: background 0.15s; }
        button:hover { background: var(--accent2); }
        button.g { background: #22c55e; } button.g:hover { background: #16a34a; }
        button.sm { padding: 4px 9px; font-size: 0.72rem; }

        /* File cards */
        .fc { background: var(--card); padding: 10px; border-radius: 8px; margin-bottom: 6px; font-size: 0.82rem; }
        .fc-name { font-weight: 600; color: var(--accent); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .fc-meta { font-size: 0.68rem; color: var(--muted); display: flex; justify-content: space-between; margin-top: 3px; }
        .fc-id   { font-family: monospace; font-size: 0.65rem; color: #475569; margin-top: 2px; }

        /* Forms */
        .form-col { display: flex; flex-direction: column; gap: 5px; margin-bottom: 10px; }
        .form-col input { background: var(--card); border-radius: 8px; padding: 7px 10px; }

        /* Node info */
        .node-info { margin-top: auto; padding-top: 12px; border-top: 1px solid #1e293b; font-size: 0.72rem; }
        #nid  { color: var(--muted); font-family: monospace; font-size: 0.6rem; word-break: break-all; margin-top: 2px; }
        #pcnt { color: var(--muted); font-size: 0.68rem; margin-top: 3px; }

        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

<!-- â”€â”€ LEFT : Peers â”€â”€ -->
<aside>
    <div class="tabs">
        <div class="tab active" id="tp" onclick="switchMode('p2p')">Peers</div>
        <div class="tab" id="tg" onclick="switchMode('gemini')">Gemini AI</div>
    </div>
    <div id="peer-list"><div class="b sys">Scanning LAN...</div></div>
    <div class="node-info">
        <strong>Your Node ID</strong>
        <div id="nid">Loading...</div>
        <div id="pcnt">0 peer(s)</div>
    </div>
</aside>

<!-- â”€â”€ CENTER : Chat â”€â”€ -->
<main>
    <div class="chat-header">
        <div class="chat-title" id="ctitle">Select a Peer</div>
        <div id="badge">â— LAN</div>
    </div>
    <div class="chat-box" id="chat-box">
        <div class="b sys">Archipel P2P â€” rÃ©seau local. SÃ©lectionne un pair.</div>
    </div>
    <div class="input-row">
        <input id="mi" placeholder="Type a message..." onkeypress="if(event.key==='Enter')send()">
        <button onclick="send()">Send</button>
    </div>
</main>

<!-- â”€â”€ RIGHT : Files â”€â”€ -->
<section class="right">

    <h3>ğŸ“‚ My Shared Files</h3>
    <div id="my-files"><div class="b sys">No files shared yet.</div></div>

    <h3>ğŸ“¥ Available to Download</h3>
    <div id="avail-files"><div class="b sys">No manifests found.</div></div>

    <h3>Share a File</h3>
    <div class="form-col">
        <input id="share-path" placeholder="C:\path\to\file.txt">
        <button onclick="shareFile()">ğŸ“¤ Share</button>
    </div>

    <h3>Download (manual)</h3>
    <div class="form-col">
        <input id="dl-path" placeholder="manifests/file_abc123.json">
        <button class="g" onclick="dlManual()">ğŸ“¥ Download</button>
    </div>

</section>

<script>
// â”€â”€â”€ Ã‰tat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let mode      = 'p2p';
let curPeer   = null;
let peers     = {};
const history = {};   // RAM seulement â€” pas localStorage

const chatBox   = document.getElementById('chat-box');
const peerList  = document.getElementById('peer-list');
const myFiles   = document.getElementById('my-files');
const availFiles= document.getElementById('avail-files');

// â”€â”€â”€ Navigation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchMode(m) {
    mode = m;
    document.getElementById('tp').classList.toggle('active', m === 'p2p');
    document.getElementById('tg').classList.toggle('active', m === 'gemini');
    if (m === 'gemini') { curPeer = 'gemini'; document.getElementById('ctitle').textContent = 'Gemini AI'; renderChat('gemini'); }
    else { curPeer = null; document.getElementById('ctitle').textContent = 'Select a Peer'; chatBox.innerHTML = '<div class="b sys">Pick a peer.</div>'; }
}

function selectPeer(id) {
    mode = 'p2p'; curPeer = id;
    document.getElementById('ctitle').textContent = id.substring(0,16) + '...';
    renderChat(id);
    document.querySelectorAll('.peer-card').forEach(c => c.classList.toggle('active', c.dataset.id === id));
}

// â”€â”€â”€ Historique â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function push(id, text, type) {
    if (!history[id]) history[id] = [];
    history[id].push({text, type});
    if (curPeer === id) bubble(text, type);
}

function renderChat(id) {
    chatBox.innerHTML = '';
    (history[id] || []).forEach(m => bubble(m.text, m.type));
    if (!history[id]?.length) chatBox.innerHTML = `<div class="b sys">${id === 'gemini' ? 'Ask Gemini anything.' : 'Start of conversation.'}</div>`;
}

function bubble(text, type) {
    const d = document.createElement('div');
    d.className = `b ${type}`;
    d.textContent = text;
    chatBox.appendChild(d);
    chatBox.scrollTop = chatBox.scrollHeight;
}

function sysmsg(text) { bubble(text, 'sys'); }

// â”€â”€â”€ Envoi â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function send() {
    const text = document.getElementById('mi').value.trim();
    if (!text || !curPeer) return;
    document.getElementById('mi').value = '';

    if (mode === 'gemini') {
        push('gemini', text, 'me');
        sysmsg('Thinking...');
        try {
            const r = await post('/api/gemini', {msg: text});
            chatBox.querySelector('.b.sys:last-child')?.remove();
            push('gemini', r.answer || r.error, 'other');
        } catch { sysmsg('[Gemini offline]'); }
    } else {
        push(curPeer, text, 'me');
        try {
            const r = await postRaw('/api/send_msg', {to: curPeer.substring(0,8), msg: text});
            if (!r.ok) { const e = await r.json(); sysmsg(`âš  ${e.error}`); }
        } catch { sysmsg('[RÃ©seau local inaccessible]'); }
    }
}

// â”€â”€â”€ Share â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function shareFile() {
    const path = document.getElementById('share-path').value.trim();
    if (!path) return;
    try {
        const d = await post('/api/share', {path});
        if (d.error) { sysmsg(`âœ— ${d.error}`); return; }
        sysmsg(`âœ“ "${d.filename}" partagÃ© (${d.nb_chunks} chunks, ${fmtSize(d.size)}) â†’ ${d.broadcast_to} pair(s)`);
        sysmsg(`ğŸ“‹ Manifest sauvegardÃ© : ${d.manifest_path}`);
        document.getElementById('share-path').value = '';
        await refreshFiles();  // mise Ã  jour immÃ©diate
    } catch(e) { sysmsg(`âœ— ${e}`); }
}

// â”€â”€â”€ Download â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function dlManifest(path) {
    try {
        const d = await post('/api/download', {path});
        sysmsg(d.error ? `âœ— ${d.error}` : `â¬‡ TÃ©lÃ©chargement dÃ©marrÃ© (${d.file_id?.substring(0,16)}...)`);
    } catch(e) { sysmsg(`âœ— ${e}`); }
}

async function dlManual() {
    const path = document.getElementById('dl-path').value.trim();
    if (!path) return;
    await dlManifest(path);
    document.getElementById('dl-path').value = '';
}

// â”€â”€â”€ Refresh fichiers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function refreshFiles() {
    // Mes fichiers partagÃ©s
    try {
        const files = await get('/api/files');
        const entries = Object.entries(files);
        myFiles.innerHTML = '';
        if (!entries.length) { myFiles.innerHTML = '<div class="b sys">No files shared yet.</div>'; }
        else entries.forEach(([id, info]) => {
            const fname = info.filename || id.substring(0,8);
            const size  = info.size ? fmtSize(info.size) : '';
            myFiles.innerHTML += `
                <div class="fc">
                    <div class="fc-name" title="${fname}">${fname}</div>
                    <div class="fc-meta"><span>${size}</span>
                        <button class="sm" onclick="navigator.clipboard?.writeText('${id}')">Copy ID</button>
                    </div>
                    <div class="fc-id">${id.substring(0,20)}...</div>
                </div>`;
        });
    } catch(e) { console.error('refreshFiles:', e); }

    // Manifests disponibles (Ã  tÃ©lÃ©charger)
    try {
        const manifests = await get('/api/manifests');
        availFiles.innerHTML = '';
        if (!manifests.length) { availFiles.innerHTML = '<div class="b sys">No manifests found.</div>'; }
        else manifests.forEach(m => {
            availFiles.innerHTML += `
                <div class="fc">
                    <div class="fc-name">${m.filename || '?'}</div>
                    <div class="fc-meta">
                        <span>${m.size ? fmtSize(m.size) : ''}</span>
                        <button class="sm g" onclick="dlManifest('${m.path}')">â¬‡ Download</button>
                    </div>
                    <div class="fc-id">${(m.file_id||'').substring(0,20)}...</div>
                </div>`;
        });
    } catch(e) { console.error('refreshManifests:', e); }
}

// â”€â”€â”€ Polling â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function poll() {
    try {
        // Peers
        peers = await get('/api/peers');
        const pids = Object.keys(peers);
        peerList.innerHTML = '';
        if (!pids.length) { peerList.innerHTML = '<div class="b sys">Scanning LAN...</div>'; }
        else pids.forEach(id => {
            const d = peers[id];
            const div = document.createElement('div');
            div.className = `peer-card ${curPeer === id ? 'active' : ''}`;
            div.dataset.id = id;
            div.onclick = () => selectPeer(id);
            div.innerHTML = `<div class="peer-name">${id.substring(0,14)}...</div><div class="peer-info">${d.ip}:${d.tcp_port}</div>`;
            peerList.appendChild(div);
        });

        // Status + messages entrants
        const s = await get('/api/status');
        document.getElementById('nid').textContent  = s.node_id || 'â€”';
        document.getElementById('pcnt').textContent = `${s.peer_count || 0} peer(s) on LAN`;

        (s.new_messages || []).forEach(m => {
            const match = m.match(/^from ([^:]+): (.+)$/);
            if (match) {
                const prefix = match[1].trim();
                const text   = match[2].trim();
                const fullId = pids.find(p => p.startsWith(prefix)) || prefix;
                push(fullId, text, 'other');
            }
        });

        // Files
        await refreshFiles();

        document.getElementById('badge').className   = '';
        document.getElementById('badge').textContent = 'â— LAN';
    } catch(e) {
        document.getElementById('badge').className   = 'off';
        document.getElementById('badge').textContent = 'â— Offline';
    }
}

// â”€â”€â”€ Helpers HTTP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function get(url) {
    const r = await fetch(url);
    return r.json();
}
async function post(url, body) {
    const r = await postRaw(url, body);
    return r.json();
}
async function postRaw(url, body) {
    return fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body) });
}

function fmtSize(b) {
    if (b < 1024) return b + ' B';
    if (b < 1024*1024) return (b/1024).toFixed(1) + ' KB';
    return (b/1024/1024).toFixed(1) + ' MB';
}

setInterval(poll, 2000);
poll();
</script>
</body>
</html>
